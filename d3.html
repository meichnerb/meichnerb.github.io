---
layout: default
author: Bayley
---


  <label for="year" style="padding-left: 20px; padding-top:20px">Year</label>
  <input type="range" id="slider" style="margin:20px;">
  <input type="text" id="textbox">


<svg height=600 width=75%></svg>

<div class="sidebar">
  <div class="country-info">
    <header>Total Greenhouse Gas Emissions by Year</header>
    <p id="Name">
    </p>
    <p id="code">
    </p>
    <div id="data">
    </div>
  </div>
</div>

<script src="https://d3js.org/d3-axis.v1.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>

<script>

// ------------
//    Parse
// ------------

	var years = [];
	d3.csv("greenhouse.csv", function(error, parsed){

		for (var key in parsed[0]) {
			var num = parseFloat(key.split(" ")[0]);
			if (!isNaN(num)){
			  years.push(num);
			}
		}

		firstYear = d3.min(years);
		d3.select("#slider")
			.attr("min", d3.min(years))
			.attr("max", 2012) //d3.max(years))
			.attr("value", d3.min(years));

	});



	var RANGE = [100000000, -100000000];
	var AllData;
	var firstYear;
  var countryName = [];
  var yearlyData = [];
  var width = 900, height = 500;


	d3.csv("greenhouse.csv", function(error, parsed){

		if(!AllData)AllData = [];

		parsed.forEach(function(row, index){

			if(!row["Country Name"])return false;
			//if(index>7)return false;
      if(row["Country Name"])
        // console.log(row["Country Name"]);
        countryName.push(row["Country Name"]);


			var yearlyData = [];

			var ii = 0;
			for (var key in row) {
				if ( ii >= 4) {
					var pollution = Number(row[key]);

					if(isNaN(pollution))pollution = null;
					yearlyData.push(pollution);


					if(pollution){
						if(pollution < RANGE[0]) RANGE[0] = pollution;
						if(pollution > RANGE[1]) RANGE[1] = pollution;

						RANGE[1] = Math.min(1000000, RANGE[1]);
					}

					if(ii == 11){
						yearlyData.push(null);
						yearlyData.push(null);
					}
					if(ii == 12)yearlyData.push(null);
				}
				ii += 1;

			}

			AllData.push({name: row['Country Name'], years: yearlyData, code: row['Country Code']});


		});

	});

	d3.select("#slider")
		.on("input", function(){
			d3.select("#textbox").node().value = this.value;
			DrawCountries(this.value);
		});








// -------------
//      Draw
// --------------

var colours = ["#00ff00", "#00cc00", "#009900", "#006600", "#003300", "#000000"];



var DrawCountries = function(year){
	if(!AllData)return console.error("Data not defined yet; cannot draw");

	year = year - firstYear;



	// -- Begin Circles
		var svg = d3.select("svg");
		var circle = svg.selectAll("circle").data(AllData);
    var g = svg.append("g");
		var enter = circle.enter().append("circle");
		var cx = function(d, i) {        return 30 + (30*(i%25));      };
		var cy = function(d, i) {        return 30 + (30 * Math.floor(i/25))      };
		var color = d3.scaleOrdinal()
						  .domain([0,6])
						  .range(colours);


    var amount = AllData.length;
    console.log(amount);


    d3.json("world.json", function(error, data){

    // converts Topojson to GeoJSON
    console.log(data);
    // make sure to use the right key in data.objects!
    var featureCollection = topojson.feature(data, data.objects.countries);

    // console.log(featureCollection);

    // filter out countries using id!
    featureCollection.features = featureCollection.features.filter(function(d) {
      return d.id != "010";
    });



    featureCollection.features.forEach(function(d, i) {

        var newCode = [d.id].push(AllData['Country Code']);

        console.log(newCode);
    });

    // initializes a map projection
    // projection types: https://github.com/d3/d3-geo#azimuthal-projections
    var proj = d3.geoMercator()
        .fitSize([width, height], featureCollection);

    // creates a path generator
    var path = d3.geoPath()
      .projection(proj);

    var countries = svg.selectAll("path")
      .data(featureCollection.features);



    // country codes: https://en.wikipedia.org/wiki/ISO_3166-1_numeric
    countries.enter().append("path")
      .attr("d", path)
      .attr("stroke", "#888")
      .attr("stroke-width", 1)
      .attr("fill", getCircleColor)
      .attr("r", 10)
      .attr("class", function(d){
        return d.name;
      })
      enter.on("click", function(d) {
        document.getElementById('Name').innerHTML = d.name;
        document.getElementById('code').innerHTML = d.code;

        console.log(d.years);
        console.log(years);

        d3.select("#data").append("svg")
          .attr("class", "svg2");


        var svg = d3.select(".svg2"),
          margin = {top: 20, right: 20, bottom: 30, left: 40},
          width = +svg.attr("width") - margin.left - margin.right,
          height = +svg.attr("height") - margin.top - margin.bottom;

        var logValue = Math.floor(Math.log10(d.years));

        var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
            y = d3.scaleLinear().rangeRound([height, 0]);

        var g = svg.append("g")
          .attr("transform", "translate(70,100)");

          x.domain([d3.min(years), d3.max(years)]);
          y.domain([d3.min(d.years), d3.max(d.years)]);

          g.append("g")
            .attr("class", "axis axis--x")
            .attr("style", "width: 100px")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

          g.append("g")
            .attr("class", "axis axis--y")
            .attr("style", "height: 100px")
            .call(d3.axisLeft(y).ticks(12))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text("Year");

          g.selectAll(".bar")
            .data(AllData)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(logValue); })
            .attr("y", function(d) { return y(years); })
            .attr("width", 20)
            .attr("height", function(d) { return logValue });


      });





	// -- Find Circle Color
		function getCircleColor(d){

			// -- Get pollution
				var pollution = d.years[year];
				if(!pollution)return "#cccccc";

			// -- Get Log Value And Color
				var logValue = Math.floor(Math.log10(pollution));
				// console.log("pollution: ", pollution, 'log: ', logValue);
				return color(logValue);

			// -- Alternative Color Test
				/*var percent = logValue/6;
				var color = "rgba("+Math.round(percent*255)+",0,0)";
				return color;*/
		}

  });

};



/*
Notes...

var pollution;


1 - 10,000 = blue
10,000 - 100,000 = green
100,000 - 1,000,000 = orange
1,000,000 - 10,000,000 = red
10,000,000 - 100,000,000 = black

*/

</script>
